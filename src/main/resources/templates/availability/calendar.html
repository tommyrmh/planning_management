<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head}">
    <title>Calendrier de Disponibilités - Planning Management</title>
</head>
<body>

<div th:replace="~{fragments/layout :: navbar}"></div>

<div class="main-container">
    <div class="page-header">
        <h1><i class="bi bi-calendar3"></i> Calendrier de Disponibilités</h1>
        <div>
            <a href="/availability/new" class="btn btn-slack-primary">
                <i class="bi bi-plus-circle"></i> Déclarer Disponibilité
            </a>
            <a href="/availability" class="btn btn-slack-secondary">
                <i class="bi bi-list"></i> Liste
            </a>
        </div>
    </div>

    <!-- Filters -->
    <div class="card-slack mb-4">
        <h3 class="card-slack-title"><i class="bi bi-funnel"></i> Filtres</h3>
        <form id="filterForm" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Collaborateur</label>
                <select class="form-select" id="filterUser">
                    <option value="">Tous les collaborateurs</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Date de début</label>
                <input type="date" class="form-control" id="filterStartDate">
            </div>
            <div class="col-md-3">
                <label class="form-label">Date de fin</label>
                <input type="date" class="form-control" id="filterEndDate">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-slack-primary w-100" onclick="loadAvailabilities()">
                    <i class="bi bi-search"></i> Rechercher
                </button>
            </div>
        </form>
    </div>

    <!-- Legend -->
    <div class="card-slack mb-4">
        <div class="d-flex gap-4">
            <div class="d-flex align-items-center gap-2">
                <div style="width: 20px; height: 20px; background: #d4edda; border: 1px solid #28a745; border-radius: 3px;"></div>
                <span>Disponible</span>
            </div>
            <div class="d-flex align-items-center gap-2">
                <div style="width: 20px; height: 20px; background: #f8d7da; border: 1px solid #dc3545; border-radius: 3px;"></div>
                <span>Occupé</span>
            </div>
        </div>
    </div>

    <!-- Calendar -->
    <div class="card-slack" id="calendarContainer">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/layout :: footer}"></div>
<div th:replace="~{fragments/layout :: scripts}"></div>

<style>
.availability-timeline {
    margin-top: 20px;
}

.user-row {
    margin-bottom: 25px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.user-name {
    font-weight: bold;
    font-size: 1.1rem;
    margin-bottom: 10px;
    color: #1d1c1d;
}

.timeline-bar {
    position: relative;
    height: 40px;
    background: #e9ecef;
    border-radius: 5px;
    overflow: hidden;
}

.availability-period {
    position: absolute;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s;
    border-left: 2px solid rgba(0,0,0,0.1);
    border-right: 2px solid rgba(0,0,0,0.1);
}

.availability-period:hover {
    opacity: 0.8;
}

.period-available {
    background: #d4edda;
    color: #155724;
    border-color: #28a745;
}

.period-unavailable {
    background: #f8d7da;
    color: #721c24;
    border-color: #dc3545;
}

.timeline-dates {
    display: flex;
    justify-content: space-between;
    margin-top: 5px;
    font-size: 0.85rem;
    color: #6c757d;
}

.no-data {
    text-center: center;
    padding: 40px;
    color: #6c757d;
}
</style>

<script>
let allAvailabilities = [];

document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.replace('/login');
        return;
    }

    // Définir les dates par défaut (mois actuel)
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

    document.getElementById('filterStartDate').value = formatDateForInput(firstDay);
    document.getElementById('filterEndDate').value = formatDateForInput(lastDay);

    loadUsers();
    loadAvailabilities();
});

function loadUsers() {
    const token = localStorage.getItem('token');
    fetch('/api/users?size=100', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => response.json())
    .then(data => {
        const select = document.getElementById('filterUser');
        data.content.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = `${user.firstName} ${user.lastName}`;
            select.appendChild(option);
        });
    })
    .catch(error => console.error('Erreur:', error));
}

function loadAvailabilities() {
    const token = localStorage.getItem('token');
    const userId = document.getElementById('filterUser').value;
    const startDate = document.getElementById('filterStartDate').value;
    const endDate = document.getElementById('filterEndDate').value;

    if (!startDate || !endDate) {
        alert('Veuillez sélectionner une période');
        return;
    }

    let url = `/api/availabilities/range?startDate=${startDate}&endDate=${endDate}`;

    fetch(url, {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => response.json())
    .then(data => {
        allAvailabilities = data;
        if (userId) {
            allAvailabilities = allAvailabilities.filter(a => a.userId == userId);
        }
        displayCalendar(startDate, endDate);
    })
    .catch(error => {
        console.error('Erreur:', error);
        document.getElementById('calendarContainer').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Erreur lors du chargement des disponibilités
            </div>
        `;
    });
}

function displayCalendar(startDate, endDate) {
    const container = document.getElementById('calendarContainer');

    if (allAvailabilities.length === 0) {
        container.innerHTML = `
            <div class="no-data">
                <i class="bi bi-calendar-x" style="font-size: 3rem; color: #ccc;"></i>
                <p class="mt-3">Aucune disponibilité trouvée pour cette période</p>
            </div>
        `;
        return;
    }

    // Grouper par utilisateur
    const byUser = {};
    allAvailabilities.forEach(avail => {
        if (!byUser[avail.userId]) {
            byUser[avail.userId] = {
                name: avail.userName,
                availabilities: []
            };
        }
        byUser[avail.userId].availabilities.push(avail);
    });

    const start = new Date(startDate);
    const end = new Date(endDate);
    const totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

    let html = '<div class="availability-timeline">';

    Object.keys(byUser).forEach(userId => {
        const userData = byUser[userId];
        html += `
            <div class="user-row">
                <div class="user-name">
                    <i class="bi bi-person-circle"></i> ${userData.name}
                </div>
                <div class="timeline-bar">
        `;

        userData.availabilities.forEach(avail => {
            const availStart = new Date(avail.dateDebut);
            const availEnd = new Date(avail.dateFin);

            // Calculer la position et la largeur
            const daysFromStart = Math.max(0, Math.ceil((availStart - start) / (1000 * 60 * 60 * 24)));
            const duration = Math.ceil((availEnd - availStart) / (1000 * 60 * 60 * 24)) + 1;

            const left = (daysFromStart / totalDays) * 100;
            const width = (duration / totalDays) * 100;

            const periodClass = avail.disponible ? 'period-available' : 'period-unavailable';
            const periodText = avail.disponible ? 'Disponible' : 'Occupé';

            html += `
                <div class="availability-period ${periodClass}"
                     style="left: ${left}%; width: ${width}%;"
                     onclick="showAvailabilityDetails(${avail.id})"
                     title="${periodText}: ${formatDate(avail.dateDebut)} - ${formatDate(avail.dateFin)}">
                    <span>${formatDate(avail.dateDebut)} - ${formatDate(avail.dateFin)}</span>
                </div>
            `;
        });

        html += `
                </div>
                <div class="timeline-dates">
                    <span>${formatDate(startDate)}</span>
                    <span>${formatDate(endDate)}</span>
                </div>
            </div>
        `;
    });

    html += '</div>';
    container.innerHTML = html;
}

function showAvailabilityDetails(id) {
    const avail = allAvailabilities.find(a => a.id === id);
    if (!avail) return;

    const status = avail.disponible ? 'Disponible' : 'Occupé';
    const statusColor = avail.disponible ? 'success' : 'danger';

    let message = `
        <strong>${avail.userName}</strong><br>
        <span class="badge bg-${statusColor}">${status}</span><br>
        Du ${formatDate(avail.dateDebut)} au ${formatDate(avail.dateFin)}
    `;

    if (avail.commentaire) {
        message += `<br><br><em>${avail.commentaire}</em>`;
    }

    alert(message.replace(/<br>/g, '\n').replace(/<[^>]*>/g, ''));
}

function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function formatDateForInput(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}
</script>

</body>
</html>
