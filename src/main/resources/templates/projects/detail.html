<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Détails du Projet - Planning Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/css/slack-theme.css}" rel="stylesheet">
</head>
<body>
    <div th:replace="~{fragments/layout :: navbar}"></div>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-white mb-0">
                <i class="fas fa-folder-open me-2"></i>Détails du Projet
            </h2>
            <button class="btn btn-secondary" onclick="window.location.href='/projects'">
                <i class="fas fa-arrow-left me-2"></i>Retour à la liste
            </button>
        </div>

        <div id="loadingSpinner" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
        </div>

        <div id="errorAlert" class="alert alert-danger" style="display: none;"></div>

        <div id="projectDetails" style="display: none;">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0" id="projectName"></h4>
                    <span id="projectStatus"></span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="mb-3">
                                <i class="fas fa-info-circle me-2"></i>Informations Générales
                            </h5>
                            <table class="table table-borderless">
                                <tbody>
                                    <tr>
                                        <td class="fw-bold">Client:</td>
                                        <td id="projectClient"></td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">Date de début:</td>
                                        <td id="projectDateDebut"></td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">Date de fin:</td>
                                        <td id="projectDateFin"></td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">Créé par:</td>
                                        <td id="projectCreatedBy"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5 class="mb-3">
                                <i class="fas fa-calendar me-2"></i>Dates Importantes
                            </h5>
                            <table class="table table-borderless">
                                <tbody>
                                    <tr>
                                        <td class="fw-bold">Créé le:</td>
                                        <td id="projectCreatedAt"></td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">Modifié le:</td>
                                        <td id="projectUpdatedAt"></td>
                                    </tr>
                                    <tr id="closedAtRow" style="display: none;">
                                        <td class="fw-bold">Clôturé le:</td>
                                        <td id="projectClosedAt"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-12">
                            <h5 class="mb-3">
                                <i class="fas fa-align-left me-2"></i>Description
                            </h5>
                            <div id="projectDescription" class="p-3 bg-light rounded">
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="d-flex justify-content-end gap-2 mt-4" id="actionButtons">
                        <button id="closeProjectBtn" class="btn btn-warning" style="display: none;">
                            <i class="fas fa-check-circle me-2"></i>Clôturer le Projet
                        </button>
                        <button id="editProjectBtn" class="btn btn-primary" style="display: none;">
                            <i class="fas fa-edit me-2"></i>Modifier
                        </button>
                        <button id="deleteProjectBtn" class="btn btn-danger" style="display: none;">
                            <i class="fas fa-trash me-2"></i>Supprimer
                        </button>
                    </div>
                </div>
            </div>

            <!-- Section Tâches (à implémenter plus tard) -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-tasks me-2"></i>Tâches Associées
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        La gestion des tâches sera disponible prochainement.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmation de suppression -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmer la suppression</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Êtes-vous sûr de vouloir supprimer ce projet ?</p>
                    <p class="text-danger"><strong>Cette action est irréversible.</strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Supprimer</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/app.js}"></script>
    <script>
        let currentProject = null;
        let currentUser = null;
        let deleteModal = null;

        document.addEventListener('DOMContentLoaded', async function() {
            deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

            // Afficher message si présent
            const message = localStorage.getItem('projectMessage');
            const messageType = localStorage.getItem('projectMessageType');
            if (message) {
                showToast(message, messageType || 'info');
                localStorage.removeItem('projectMessage');
                localStorage.removeItem('projectMessageType');
            }

            // Récupérer l'ID du projet depuis l'URL
            const pathParts = window.location.pathname.split('/');
            const projectId = pathParts[pathParts.length - 1];

            // Vérifier l'authentification
            currentUser = await checkAuth();

            // Charger les détails du projet
            await loadProjectDetails(projectId);

            // Gérer les boutons d'action
            document.getElementById('editProjectBtn').addEventListener('click', function() {
                window.location.href = `/projects/${currentProject.id}/edit`;
            });

            document.getElementById('deleteProjectBtn').addEventListener('click', function() {
                deleteModal.show();
            });

            document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
                await deleteProject(currentProject.id);
            });

            document.getElementById('closeProjectBtn').addEventListener('click', async function() {
                await closeProject(currentProject.id);
            });
        });

        async function loadProjectDetails(projectId) {
            try {
                const token = getAuthToken();
                if (!token) {
                    window.location.href = '/login';
                    return;
                }

                const response = await fetch(`/api/projects/${projectId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                if (!response.ok) {
                    throw new Error('Projet non trouvé');
                }

                currentProject = await response.json();
                displayProjectDetails(currentProject);

                // Afficher les boutons selon les permissions
                displayActionButtons(currentProject);

                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('projectDetails').style.display = 'block';
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
                const errorAlert = document.getElementById('errorAlert');
                errorAlert.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${error.message}
                `;
                errorAlert.style.display = 'block';
            }
        }

        function displayProjectDetails(project) {
            document.getElementById('projectName').textContent = project.nom;
            document.getElementById('projectStatus').innerHTML = getStatusBadge(project.statut);
            document.getElementById('projectClient').textContent = project.client || '-';
            document.getElementById('projectDateDebut').textContent = formatDate(project.dateDebut);
            document.getElementById('projectDateFin').textContent = formatDate(project.dateFin);
            document.getElementById('projectCreatedBy').textContent = project.createdByUsername || '-';
            document.getElementById('projectCreatedAt').textContent = formatDateTime(project.createdAt);
            document.getElementById('projectUpdatedAt').textContent = formatDateTime(project.updatedAt);
            document.getElementById('projectDescription').textContent = project.description || 'Aucune description';

            if (project.closedAt) {
                document.getElementById('closedAtRow').style.display = 'table-row';
                document.getElementById('projectClosedAt').textContent = formatDateTime(project.closedAt);
            }
        }

        function displayActionButtons(project) {
            if (!currentUser) return;

            const isManager = currentUser.role === 'MANAGER';
            const isAdmin = currentUser.role === 'ADMIN';

            // Bouton modifier : MANAGER ou ADMIN
            if (isManager || isAdmin) {
                document.getElementById('editProjectBtn').style.display = 'inline-block';
            }

            // Bouton supprimer : ADMIN seulement
            if (isAdmin) {
                document.getElementById('deleteProjectBtn').style.display = 'inline-block';
            }

            // Bouton clôturer : MANAGER ou ADMIN, et projet non terminé
            if ((isManager || isAdmin) && project.statut !== 'TERMINE') {
                document.getElementById('closeProjectBtn').style.display = 'inline-block';
            }
        }

        async function deleteProject(projectId) {
            try {
                const token = getAuthToken();
                const response = await fetch(`/api/projects/${projectId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.message || 'Erreur lors de la suppression');
                }

                // Succès - afficher notification et rediriger
                localStorage.setItem('projectMessage', 'Projet supprimé avec succès');
                localStorage.setItem('projectMessageType', 'success');
                window.location.href = '/projects';
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la suppression: ' + error.message);
                deleteModal.hide();
            }
        }

        async function closeProject(projectId) {
            try {
                const token = getAuthToken();
                const response = await fetch(`/api/projects/${projectId}/close`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.message || 'Erreur lors de la clôture');
                }

                // Succès - afficher notification et recharger
                localStorage.setItem('projectMessage', 'Projet clôturé avec succès');
                localStorage.setItem('projectMessageType', 'success');
                window.location.reload();
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la clôture: ' + error.message);
            }
        }

        function getStatusBadge(statut) {
            const statusMap = {
                'EN_PREPARATION': { label: 'En préparation', class: 'bg-secondary' },
                'EN_COURS': { label: 'En cours', class: 'bg-primary' },
                'EN_PAUSE': { label: 'En pause', class: 'bg-warning' },
                'TERMINE': { label: 'Terminé', class: 'bg-success' },
                'ANNULE': { label: 'Annulé', class: 'bg-danger' }
            };
            const status = statusMap[statut] || { label: statut, class: 'bg-secondary' };
            return `<span class="badge ${status.class}">${status.label}</span>`;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR');
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR') + ' ' + date.toLocaleTimeString('fr-FR');
        }
    </script>
</body>
</html>
